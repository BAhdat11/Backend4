<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytical Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ===== RESET ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* ===== BODY ===== */
    body {
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      min-height: 100vh;
      padding: 30px;
      color: #333;
    }

    /* ===== CONTAINER ===== */
    .container {
      max-width: 1100px;
      margin: auto;
      background: #ffffff;
      border-radius: 14px;
      padding: 28px 32px 36px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    /* ===== TITLE ===== */
    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      color: #2d2d2d;
    }

    /* ===== CONTROLS ===== */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: flex-end;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 180px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: #555;
    }

    /* ===== INPUTS ===== */
    select,
    input[type="date"] {
      padding: 9px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    select:focus,
    input[type="date"]:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    /* ===== BUTTON ===== */
    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 11px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
      white-space: nowrap;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(102, 126, 234, 0.35);
    }

    button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* ===== ERROR ===== */
    .error-message {
      background: #ffe3e3;
      color: #b00020;
      border-left: 4px solid #b00020;
      padding: 10px 14px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: none;
    }
    .error-message.show { display: block; }

    /* ===== LOADING ===== */
    .loading {
      display: none;
      margin: 15px 0;
      font-weight: 600;
      color: #667eea;
    }
    .loading.show { display: block; }

    /* ===== METRICS ===== */
    .metrics-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: #f8f9ff;
      border-radius: 12px;
      padding: 18px;
      text-align: center;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    }

    .metric-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
    }

    .metric-value {
      font-size: 22px;
      font-weight: 700;
      color: #333;
    }

    /* ===== CHART ===== */
    .chart-container {
      height: 420px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ðŸ“Š Analytical Platform</h1>

    <div class="error-message" id="errorMessage"></div>

    <div class="controls">
      <div class="control-group">
        <label for="fieldSelect">Select Field:</label>
        <select id="fieldSelect">
          <option value="field1">Field 1 (e.g., Temperature)</option>
          <option value="field2">Field 2 (e.g., Humidity)</option>
          <option value="field3">Field 3 (e.g., CO2 Levels)</option>
        </select>
      </div>

      <div class="control-group">
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate" required>
      </div>

      <div class="control-group">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate" required>
      </div>

      <button id="fetchButton" onclick="fetchData()">Fetch Data & Visualize</button>
    </div>

    <div class="loading" id="loading">Loading data...</div>

    <div class="metrics-container" id="metricsContainer" style="display: none;">
      <div class="metric-card">
        <div class="metric-label">Average</div>
        <div class="metric-value" id="avgValue">-</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Minimum</div>
        <div class="metric-value" id="minValue">-</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Maximum</div>
        <div class="metric-value" id="maxValue">-</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Standard Deviation</div>
        <div class="metric-value" id="stdDevValue">-</div>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="chartCanvas"></canvas>
    </div>
  </div>

  <script>
    let chart = null;

    // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
    window.onload = () => {
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      document.getElementById('endDate').value = today.toISOString().split('T')[0];
      document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    };

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
      setTimeout(() => errorDiv.classList.remove('show'), 5000);
    }

    function hideError() {
      document.getElementById('errorMessage').classList.remove('show');
    }

    async function handleResponse(response) {
      if (!response.ok) {
        const error = await response.json().catch(() => ({
          error: `Server error: ${response.status}`
        }));
        throw new Error(error.error || `Failed: ${response.status}`);
      }
      return response.json();
    }

    async function fetchData() {
      const field = document.getElementById('fieldSelect').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const loadingDiv = document.getElementById('loading');
      const fetchButton = document.getElementById('fetchButton');

      if (!startDate || !endDate) {
        showError('Please select both start and end dates');
        return;
      }
      if (new Date(startDate) > new Date(endDate)) {
        showError('Start date must be before or equal to end date');
        return;
      }

      hideError();
      loadingDiv.classList.add('show');
      fetchButton.disabled = true;

      try {
        const params = `field=${field}&start_date=${startDate}&end_date=${endDate}`;

        const [measurements, metrics] = await Promise.all([
          fetch(`/api/measurements?${params}`).then(handleResponse),
          fetch(`/api/measurements/metrics?${params}`).then(handleResponse)
        ]);

        document.getElementById('avgValue').textContent = metrics.avg;
        document.getElementById('minValue').textContent = metrics.min;
        document.getElementById('maxValue').textContent = metrics.max;
        document.getElementById('stdDevValue').textContent = metrics.stdDev;
        document.getElementById('metricsContainer').style.display = 'grid';

        createChart(measurements, field);
      } catch (error) {
        console.error('Error:', error);
        showError(error.message);
        document.getElementById('metricsContainer').style.display = 'none';
        if (chart) {
          chart.destroy();
          chart = null;
        }
      } finally {
        loadingDiv.classList.remove('show');
        fetchButton.disabled = false;
      }
    }

    function createChart(data, field) {
      if (typeof Chart === 'undefined') {
        showError('Chart.js library is not loaded. Please refresh the page.');
        return;
      }

      const ctx = document.getElementById('chartCanvas').getContext('2d');
      if (chart) chart.destroy();

      const labels = data.map(item => {
        const date = new Date(item.timestamp);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
      });
      const values = data.map(item => item[field]);

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: field.charAt(0).toUpperCase() + field.slice(1),
            data: values,
            borderColor: 'rgb(102, 126, 234)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: 'Value' }
            },
            x: {
              title: { display: true, text: 'Timestamp' },
              ticks: { maxRotation: 45, minRotation: 45 }
            }
          },
          interaction: { mode: 'nearest', axis: 'x', intersect: false }
        }
      });
    }
  </script>
</body>
</html>
